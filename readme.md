# Smartdoor_K230

这是SmartDoor项目配套的 运行在K230上的程序

基于嘉楠 K230 的 AI 视觉从机控制器，支持人脸检测、人脸识别、人脸注册等功能。

> 🎯 **核心特点**：摄像头 24 小时常驻运行，AI 模型按需热切换，彻底解决资源阻塞问题。

## 📋 目录

- [功能特性](#功能特性)
- [硬件要求](#硬件要求)
- [快速开始](#快速开始)
- [命令协议](#命令协议)
- [人脸注册管理](#人脸注册管理)
- [架构设计](#架构设计)
- [开发历程](#开发历程)
- [常见问题](#常见问题)

## 功能特性

- ✅ **人脸检测** - 实时检测画面中的人脸位置
- ✅ **人脸识别** - 识别已注册的人脸身份
- ✅ **人脸注册** - 通过摄像头采集人脸并注册到数据库
- ✅ **动态帧率** - 空闲时自动降帧，节省功耗
- ✅ **串口控制** - 通过 UART 接收命令，发送检测结果
- ✅ **热切换** - 毫秒级切换 AI 功能，无需重启摄像头

## 硬件要求

- 嘉楠 K230 开发板（CanMV-K230）
- ST7701 LCD 显示屏（或兼容屏幕）
- GC2093 摄像头模组
- UART 连接主控 MCU

## 快速开始

### 1. 文件部署

将以下文件拷贝到 K230 的 `/sdcard/` 目录：

```
/sdcard/
├── libs/
│   ├── K230Protocol.py
│   ├── K230SlaveController.py
│   ├── K230Uart.py
│   ├── CameraManager.py
│   ├── AIProcessor.py
│   ├── AIBase.py
│   └── AI2D.py
├── modules/
│   ├── face_detection.py
│   ├── face_recognition.py
│   └── face_registration.py
├── kmodel/
│   ├── face_detection_320.kmodel
│   └── face_recognition.kmodel
├── utils/
│   └── prior_data_320.bin
├── data/
│   └── face_database/        # 人脸特征存储目录（自动创建）
└── main.py
```

### 2. 运行程序

```python
# 在 K230 REPL 中执行
exec(open('/sdcard/main.py').read())
```

### 3. 发送命令测试

通过串口发送（波特率 115200）：

```
$CMD,PING#              → 返回 $RSP,PONG,K230#
$CMD,START,6#           → 启动人脸检测
$CMD,START,8#           → 启动人脸识别
$CMD,REGCAM,zhangsan#   → 从摄像头注册用户 zhangsan
$CMD,STOP#              → 停止当前功能
```

## 命令协议

### 命令格式

```
$CMD,<命令>[,参数1,参数2...]#
```

### 响应格式

```
$RSP,<长度>,<状态>,<消息>[,额外数据]#
```

### 数据格式

```
$<长度>,<功能ID>,<x>,<y>,<w>,<h>[,额外数据]#
```

### 完整命令列表

| 命令 | 说明 | 示例 | 响应示例 |
|------|------|------|----------|
| `PING` | 测试连接 | `$CMD,PING#` | `$RSP,PONG,K230#` |
| `STATUS` | 查询状态 | `$CMD,STATUS#` | `$RSP,OK,1,8#` (运行中,人脸识别) |
| `START,<id>` | 启动功能 | `$CMD,START,6#` | `$RSP,OK,Started:6#` |
| `STOP` | 停止功能 | `$CMD,STOP#` | `$RSP,OK,Stopped#` |
| `REGCAM,<user_id>` | 摄像头注册 | `$CMD,REGCAM,zhangsan#` | `$RSP,OK,Registered:zhangsan#` |
| `LIST` | 列出注册用户 | `$CMD,LIST#` | `$RSP,OK,zhangsan,lisi,wangwu#` |
| `DELETE,<user_id>` | 删除用户 | `$CMD,DELETE,zhangsan#` | `$RSP,OK,Deleted#` |
| `RELOAD` | 重载数据库 | `$CMD,RELOAD#` | `$RSP,OK,Reloaded#` |
| `SET,<key>,<value>` | 设置参数 | `$CMD,SET,fps,15#` | `$RSP,OK,fps=15#` |
| `GET,<key>` | 获取参数 | `$CMD,GET,fps#` | `$RSP,OK,fps=15#` |
| `RESET` | 系统重置 | `$CMD,RESET#` | `$RSP,OK,Reset#` |

### 功能 ID

| ID | 功能 | 说明 |
|----|------|------|
| 6 | 人脸检测 | 检测人脸位置，返回坐标 |
| 8 | 人脸识别 | 检测+识别，返回坐标和身份 |
| 100 | 人脸注册 | 内部使用，通过 REGCAM 命令触发 |

### 数据包格式

#### 人脸检测数据 (ID=6)
```
$<len>,06,<x>,<y>,<w>,<h>#
```
示例：`$21,06,120,080,150,180#`

#### 人脸识别数据 (ID=8)
```
$<len>,08,<x>,<y>,<w>,<h>,<name>,<score>#
```
示例：`$35,08,120,080,150,180,zhangsan,095#`

- `score`: 相似度 (0-100)，95 表示 95% 匹配度
- `name`: 用户名，未识别时为 `unknown`

---

## 人脸注册管理

### 注册流程

```
┌─────────────┐     $CMD,REGCAM,user_id#     ┌─────────────┐
│   主控 MCU   │ ─────────────────────────▶  │    K230     │
└─────────────┘                              └──────┬──────┘
                                                    │
                                    ┌───────────────┼───────────────┐
                                    ▼               ▼               ▼
                              ┌─────────┐     ┌─────────┐     ┌─────────┐
                              │ 检测人脸 │ ──▶ │ 稳定计数 │ ──▶ │ 提取特征 │
                              │ (实时)  │     │ (5帧)   │     │ (保存)  │
                              └─────────┘     └─────────┘     └─────────┘
                                                                    │
┌─────────────┐     $RSP,OK,Registered:user_id#                     │
│   主控 MCU   │ ◀──────────────────────────────────────────────────┘
└─────────────┘
```

### 注册命令详解

#### REGCAM - 从摄像头注册

```
$CMD,REGCAM,<user_id>#
```

**参数**：
- `user_id`: 用户标识符，建议使用英文字母和数字，如 `user001`、`zhangsan`

**响应**：

| 状态 | 响应 | 说明 |
|------|------|------|
| 成功 | `$RSP,OK,Registered:<user_id>#` | 注册成功 |


---

### 用户管理命令

#### LIST - 列出所有注册用户

```
$CMD,LIST#
```

**响应**：
```
$RSP,OK,user1,user2,user3#    # 有用户
$RSP,OK,empty#                 # 无用户
```

**示例**：
```
TX: $CMD,LIST#
RX: $RSP,OK,zhangsan,lisi,wangwu#
```

---

#### DELETE - 删除用户

```
$CMD,DELETE,<user_id>#
```

**响应**：
```
$RSP,OK,Deleted#              # 删除成功
$RSP,ERR,Not found#           # 用户不存在
```

**示例**：
```
TX: $CMD,DELETE,zhangsan#
RX: $RSP,OK,Deleted#
```

---

#### RELOAD - 重新加载数据库

当外部修改了人脸数据库文件后，使用此命令刷新内存中的数据。

```
$CMD,RELOAD#
```

**响应**：
```
$RSP,OK,Reloaded#
```

---

### 数据库存储

人脸特征以二进制文件存储：

```
/data/face_database/
├── zhangsan.bin      # 张三的人脸特征 (512 floats)
├── lisi.bin          # 李四的人脸特征
└── wangwu.bin        # 王五的人脸特征
```

**文件格式**：
- 每个 `.bin` 文件包含 512 个 float32 数值（2048 字节）
- 文件名即用户 ID（不含扩展名）

---

### 注册最佳实践

1. **光线充足** - 避免逆光或昏暗环境
2. **正面面对** - 摄像头与人脸正对，避免侧脸
3. **适当距离** - 人脸占画面 10%-50%
4. **保持稳定** - 注册过程中保持 2 秒不动
5. **摘除遮挡** - 摘下口罩、墨镜等遮挡物
6. **单人注册** - 确保画面中只有一个人



## 架构设计

### 系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                        主控 MCU                               │
│                    (发送命令/接收结果)                         │
└─────────────────────────┬────────────────────────────────────┘
                          │ UART (115200bps)
┌─────────────────────────┴────────────────────────────────────┐
│                        K230 从机                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                   K230Controller                        │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐  │  │
│  │  │  K230Uart   │  │ K230Protocol│  │   主循环       │  │  │
│  │  │  串口收发   │  │  协议解析   │  │ 命令+AI处理   │  │  │
│  │  └─────────────┘  └─────────────┘  └────────────────┘  │  │
│  └────────────────────────────────────────────────────────┘  │
│                              │                                │
│                              ▼                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                      PipeLine                           │  │
│  │              (摄像头 + 显示 + 媒体管理)                  │  │
│  │                      24H 常驻运行                        │  │
│  └────────────────────────────────────────────────────────┘  │
│                              │                                │
│         ┌────────────────────┼────────────────────┐          │
│         ▼                    ▼                    ▼          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ FaceDetModule│    │ FaceRecModule│    │ FaceRegModule│   │
│  │  (人脸检测)  │    │  (人脸识别)  │    │  (人脸注册)  │   │
│  │  延迟加载    │    │  延迟加载    │    │  延迟加载    │   │
│  └──────────────┘    └──────────────┘    └──────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

### 核心设计理念

**单一 PipeLine + 延迟加载模块**

- `PipeLine`：摄像头、显示、媒体的统一管理器，启动后常驻运行
- 功能模块：按需加载，用完即释放

这种设计实现了：
- ⚡ 功能切换从 **3 秒** 降到 **<500ms**
- 🛡️ 避免了媒体资源频繁开关导致的死锁
- 🔋 支持空闲时降帧以减少发热
- 🎯 人脸注册复用主 PipeLine，无资源冲突

---

## 开发历程

> 这是一段与 K230 媒体系统"斗智斗勇"的血泪史，也是一个"大道至简"的故事。

### 🌅 第一阶段：单线程方案（阻塞地狱）

**问题**：串口命令处理和 AI 推理都在主循环，命令响应严重延迟。

```python
# 原始方案：单线程
while True:
    cmd = uart.read()           # 阻塞！
    if cmd == "START":
        pipeline.create()        # 阻塞 2-3 秒！
        while running:
            frame = get_frame()  # AI 处理
            process(frame)
        pipeline.destroy()       # 又阻塞！
```

**症状**：发送 STOP 命令后，需要等当前帧处理完才能响应，体验极差。

---

### 🌊 第二阶段：多线程方案（死锁深渊）

**想法**：用 `_thread` 模块分离命令处理和 AI 推理。

```python
# 多线程方案
def ai_thread():
    pipeline.create()   # 💀 在子线程初始化媒体
    while not stop:
        process()
    pipeline.destroy()  # 💀 在子线程销毁媒体

_thread.start_new_thread(ai_thread, ())
```

**结果**：

```
[AI Thread] Initializing...
find sensor gc2093_csi2, type 8, output 1920x1080@30
vb common pool count 6
# 💀 卡死，永远不动了
```

**原因**：K230 的 `sensor` 和 `MediaManager` **只能在主线程操作**！在子线程初始化会导致底层驱动死锁。

---

### 🌪️ 第三阶段：混合模式（依然卡顿）

**尝试**：主线程负责初始化/销毁，子线程只做推理。

```python
# 混合方案
def main():
    pipeline.create()           # 主线程初始化
    _thread.start_new_thread(ai_loop, ())
    while True:
        cmd = uart.read()
        if cmd == "STOP":
            stop_flag = True
            pipeline.destroy()  # 主线程销毁
```

**问题**：每次切换功能仍需要完整的 `create()` → `destroy()` 周期，耗时 2-3 秒，而且偶尔还是会卡住。

---

### 🔬 第四阶段：过度设计（复杂度爆炸）

此时，我开始怀疑是架构问题，于是引入了更"高级"的设计：

```python
# "高级"方案：预加载 + 资源分离
class AIProcessor:
    def preload_all(self):
        # 在 MediaManager.init() 之前加载所有模型！
        self.face_det = FaceDetector(...)
        self.face_reg = FaceRecognition(...)
    
class CameraManager:
    def pause_sensor(self):
        self.sensor.stop()  # 给 AI 加载腾空间
    
    def resume_sensor(self):
        self._init_sensor()  # 重新初始化
```

**想法很美好**：
- 预加载所有模型，切换时瞬间完成
- 分离 `CameraManager` 和 `AIProcessor`
- 人脸注册时暂停/恢复摄像头

**现实很骨感**：

```
[AI] Preloading models...
[Camera] Starting...
# 💀 又卡死了，这次更惨
```

**这个"高级"方案引入了更多问题**：
1. 模型预加载时机与 `MediaManager` 冲突
2. `sensor.stop()` 后无法直接 `sensor.run()`，必须重新初始化
3. 资源释放顺序稍有不对就死锁
4. 代码复杂度爆炸，bug 无处不在

---

### 🔍 第五阶段：向历史学习（DeepWiki 考古）

在崩溃边缘，我想起之前有一版代码是能正常工作的（虽然 bug 多）。但是...我把它删了 😭

幸运的是，DeepWiki 还有这个仓库的索引！于是我向 AI 求助，让它分析历史代码：

> **提问**：请分析这个仓库中早期能正常工作的版本，找出人脸检测和识别不阻塞的关键...

**DeepWiki 的关键发现**：

```
1. 旧版本使用单一 PipeLine 管理所有资源
2. 模型是延迟加载的（需要时才 init）
3. 切换模式的顺序是：stop() → deinit() → gc.collect() → init() → start()
4. 人脸注册复用主 PipeLine，不创建新的
```

原来，旧版本的设计是**延迟加载 + 单一资源管理器**，而我的"优化"反而破坏了这个简单有效的架构！

---

### 💡 第六阶段：大道至简（最终方案）

> 💡 "既然开关摄像头这么麻烦，那就... **不关了**！"

**核心顿悟**：

| 错误思路 | 正确思路 |
|----------|----------|
| 预加载所有模型 | 需要时才加载 |
| 分离 CameraManager | 用单一 PipeLine |
| 切换时暂停摄像头 | 摄像头永远运行 |
| 复杂的资源状态机 | 简单的 stop→deinit→init→start |



---

### 📚 经验总结

这次开发经历让我深刻理解了几个道理：

#### 1. 简单优于复杂

> "看似幼稚的方案反而成功，看似高级的设计反而失败"

预加载、资源分离、状态机... 这些"高级"设计不仅没有解决问题，反而引入了更多 bug。最终成功的方案反而是最直接的：**需要什么，就加载什么；不用了，就释放掉**。

#### 2. 了解平台限制

K230 的媒体系统有很多隐藏的"规矩"：
- `sensor` 和 `MediaManager` 只能在主线程操作
- `sensor.stop()` 后不能直接 `run()`，要重新初始化
- 资源释放顺序有严格要求

不了解这些，再精妙的设计也是空中楼阁。

#### 3. 历史代码是宝藏

当我走投无路时，是对旧代码的考古救了我。那些被认为"有 bug"、"不优雅"的代码，往往包含了在实践中摸索出的宝贵经验。

#### 4. 先跑起来，再优化

```
能运行的"丑"代码 > 不能运行的"美"代码
```

---

### 🎭 这次探索的心路历程

```
😊 "这个架构设计很优雅！"
     ↓
🤔 "怎么卡住了？"
     ↓
😰 "加点锁应该能解决..."
     ↓
😱 "为什么更卡了！"
     ↓
🤯 "重构！这次用更专业的设计！"
     ↓
💀 "......"
     ↓
🔍 "让我看看以前的代码是怎么写的..."
     ↓
💡 "原来这么简单就行了？！"
     ↓
🎉 "它跑起来了！！！"
```

---

## 常见问题

### Q: 启动时报 `NameError: name 'xxx' isn't defined`

**A**: 检查导入语句，确保 `from media.xxx import *` 正确。

### Q: 画面卡住不动

**A**: 检查是否调用了 `pl.show_image()`，即使空闲状态也需要刷新显示。

### Q: 模型加载失败

**A**: 确认 `/sdcard/kmodel/` 目录下有对应的 `.kmodel` 文件。

### Q: 串口收不到数据

**A**: 
- 检查波特率是否为 115200
- 确认命令格式正确：`$CMD,PING#`（注意结尾的 `#`）

### Q: 切换功能时偶尔失败

**A**: 先发送 `$CMD,STOP#` 停止当前功能，等待响应后再发送 `START`。

### Q: 人脸注册超时

**A**: 
- 确保光线充足
- 人脸正对摄像头
- 保持稳定 2 秒以上
- 人脸占画面 10% 以上

### Q: 识别准确率低

**A**: 
- 检查注册时的照片质量
- 适当降低 `face_threshold`（默认 0.65）
- 重新注册用户

### Q: 模型预加载不是更快吗？为什么不用？

**A**: 理论上是，但 K230 的媒体系统对初始化顺序有严格要求。预加载会导致资源冲突，得不偿失。延迟加载虽然每次切换多花 0.3 秒，但胜在稳定可靠。

---

## 致谢

- 嘉楠科技 K230 SDK
- CanMV 开源社区
- [DeepWiki](https://deepwiki.com) - 关键时刻的代码考古工具
- Claude / Gemini / ChatGPT / Qwen - AI 辅助开发与调试

## License

MIT License

---

**Made with 💻 and ☕ by [Exmeaning]**

*"调试 K230 的日子，让我学会了什么叫'大道至简'。"*

*"有时候，最初的'幼稚'想法，恰恰是最正确的答案。"*